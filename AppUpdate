/**
 * AppUpdate.js - æ‰¹é‡æ£€æµ‹ App Store æ›´æ–°ï¼ˆè‡ªåŠ¨æå– ID é“¾æ¥ç‰ˆï¼‰
 *
 * ä½¿ç”¨è¯´æ˜ï¼š
 * - åœ¨ Loon æ’ä»¶ Argument ä¸­å¡«å†™ app_idsï¼Œä¾‹å¦‚ï¼š
 *   https://apps.apple.com/us/app/my-baby-unicorn/id1442079205?l=zh-Hans-CN,1051902027
 * - æ”¯æŒé€—å·ã€ç©ºæ ¼ã€åˆ†å·ã€æ¢è¡Œã€ä¸­æ–‡é€—å·åˆ†éš”
 * - è‡ªåŠ¨æå– URL ä¸­ id åé¢çš„æ•°å­—
 * - æ— é»˜è®¤ IDï¼šæœªä¼ å…¥æœ‰æ•ˆ IDï¼Œè„šæœ¬ç›´æ¥é€€å‡º
 */

const AGGREGATE = false; // æ˜¯å¦åˆå¹¶é€šçŸ¥ï¼ˆfalse = æ¯ä¸ª App å•ç‹¬é€šçŸ¥ï¼‰

/* ---------------------- è¾…åŠ©å‡½æ•° ---------------------- */

/**
 * æå–è¾“å…¥ä¸­æ‰€æœ‰æœ‰æ•ˆ App ID
 * @param {string|object} rawArg - $argument æˆ–å­—ç¬¦ä¸²
 * @returns {string[]} - æ•°å­— App ID æ•°ç»„
 */
function extractAppIds(rawArg) {
  if (!rawArg) return [];

  let rawStr = "";

  // æ”¯æŒå¯¹è±¡ argument
  if (typeof rawArg === "object" && rawArg !== null) {
    const preferKeys = ["app_ids", "appIds", "arg", "arg1", "arg0"];
    for (const k of preferKeys) {
      if (Object.prototype.hasOwnProperty.call(rawArg, k) && rawArg[k]) {
        rawStr = String(rawArg[k]);
        break;
      }
    }
    if (!rawStr) {
      rawStr = Object.keys(rawArg).map(k => String(rawArg[k] || "")).join(",");
    }
  }

  // æ”¯æŒå­—ç¬¦ä¸² argument
  if (typeof rawArg === "string") rawStr = rawArg;

  // æŒ‰å¤šç§åˆ†éš”ç¬¦æ‹†åˆ†
  const items = rawStr.split(/[\s,;ï¼Œ\n\r]+/).map(s => s.trim()).filter(Boolean);

  // æå– id åçš„æ•°å­—æˆ–çº¯æ•°å­— ID
  const ids = items.map(s => {
    const match = s.match(/id(\d+)/i);
    if (match) return match[1];
    if (/^\d+$/.test(s)) return s;
    return null;
  }).filter(Boolean);

  return ids;
}

function getAppInfo(appId) {
  const url = `https://itunes.apple.com/lookup?id=${appId}`;
  return new Promise((resolve, reject) => {
    $httpClient.get(url, (err, resp, data) => {
      if (err) return reject(err);
      try {
        const obj = JSON.parse(data);
        if (obj && obj.resultCount > 0) resolve(obj.results[0]);
        else reject(new Error(`App ID ${appId} æœªæ‰¾åˆ°ä¿¡æ¯`));
      } catch (e) {
        reject(e);
      }
    });
  });
}

async function checkApp(appId) {
  const STORE_KEY = `app_update_${appId}_version`;
  try {
    const info = await getAppInfo(appId);
    const name = info.trackName || `App(${appId})`;
    const version = info.version || "";
    const appUrl = info.trackViewUrl || `https://apps.apple.com/app/id${appId}`;
    const notes = info.releaseNotes || "æš‚æ— æ›´æ–°æ—¥å¿—";

    const lastVersion = $persistentStore.read(STORE_KEY);
    if (lastVersion !== version) {
      const shortNotes = notes.split("\n").slice(0, 5).join("\n");
      const title = `${name} æ›´æ–°å•¦ ğŸ‰`;
      const sub = `ç‰ˆæœ¬ï¼š${version}`;
      const content = `${shortNotes}`;
      $notification.post(title, sub, content, appUrl);
      $persistentStore.write(version, STORE_KEY);
      console.log(`${name} (${appId}) æ›´æ–°è‡³ ${version}ï¼Œå·²é€šçŸ¥ã€‚`);
      return { id: appId, name, version, updated: true, notes: shortNotes, url: appUrl };
    } else {
      console.log(`${name} (${appId}) æ— æ›´æ–°ï¼ˆå½“å‰ç‰ˆæœ¬ ${version}ï¼‰`);
      return { id: appId, name, version, updated: false };
    }
  } catch (err) {
    console.error(`App ID ${appId} æ£€æµ‹å¤±è´¥ï¼š`, err && err.message ? err.message : err);
    return { id: appId, error: err && err.message ? err.message : String(err) };
  }
}

async function main() {
  // è§£æ $argument
  const rawArg = (typeof $argument !== "undefined") ? $argument : "";
  let ids = extractAppIds(rawArg);

  // å…¼å®¹ä» persistentStore è¯»å– app_ids
  if ((!ids || ids.length === 0) && typeof $persistentStore !== "undefined") {
    const stored = $persistentStore.read("app_ids") || "";
    if (stored) ids = ids.concat(extractAppIds(stored));
  }

  if (!ids || ids.length === 0) {
    console.error("è¯·åœ¨æ’ä»¶ Argument ä¸­ä¼ å…¥è‡³å°‘ä¸€ä¸ª App IDï¼ˆä¾‹å¦‚ï¼š1051902027 æˆ–å®Œæ•´ App é“¾æ¥ï¼‰");
    $done();
    return;
  }

  // è¿‡æ»¤çº¯æ•°å­—æœ‰æ•ˆ ID
  const validIds = ids.filter(id => /^\d+$/.test(id));
  if (validIds.length === 0) {
    console.error("æœªå‘ç°æœ‰æ•ˆçš„æ•°å­—å‹ App IDï¼Œè¯·æ£€æŸ¥è¾“å…¥æ ¼å¼ã€‚");
    $done();
    return;
  }

  // é¡ºåºæ£€æµ‹
  const results = [];
  for (const id of validIds) {
    // eslint-disable-next-line no-await-in-loop
    const r = await checkApp(id);
    results.push(r);
  }

  // å¯é€‰ï¼šåˆå¹¶é€šçŸ¥
  if (AGGREGATE) {
    const updated = results.filter(r => r.updated);
    if (updated.length > 0) {
      const title = `AppStore: ${updated.length} ä¸ªåº”ç”¨æœ‰æ›´æ–°`;
      const lines = updated.map(u => `${u.name} â†’ ${u.version}`).slice(0, 10);
      const content = lines.join("\n");
      $notification.post(title, "", content);
    } else {
      console.log("æ²¡æœ‰åº”ç”¨æ›´æ–°ï¼Œåˆå¹¶é€šçŸ¥æœªå‘é€ã€‚");
    }
  }

  $done();
}

main();
